{"version":3,"file":"index.umd.js","sources":["../src/util.js","../src/index.js"],"sourcesContent":["// @flow\n\n/**\n * Copy all properties from `props` onto `obj`.\n * @param {object} obj Object onto which properties should be copied.\n * @param {object} props Object from which to copy properties.\n * @returns {object}\n * @private\n */\nexport function assign(obj /*: Object */, props /*: Object */) /*: Object */ {\n\tfor (let i in props) obj[i] = props[i];\n\treturn obj;\n}\n\n/**\n * Get flattened children from the children prop\n * @param {Array} accumulator\n * @param {any} children A `props.children` opaque object.\n * @returns {Array} accumulator\n * @private\n */\nexport function getChildren(\n\taccumulator /*: Array<Object> */,\n\tchildren /*: Array<Object> | Object */\n) /*: Array<Object> */ {\n\tif (Array.isArray(children)) {\n\t\tchildren.reduce(getChildren, accumulator);\n\t} else if (children != null && children !== false) {\n\t\taccumulator.push(children);\n\t}\n\treturn accumulator;\n}\n","// @flow\nimport { assign, getChildren } from \"./util\";\nimport { options, Fragment, Component } from \"preact\";\nimport { Suspense } from \"preact/compat\";\n\nconst createContextDefaultValue = \"__p\";\nconst createContextDefaultValueNew = \"__\";\nconst _skipEffects = \"__s\";\nconst _children = \"__k\"\nconst _parent = \"__\"\nconst _diff = \"__b\"\n\n/*::\ntype VNode = {\n\ttype: string | Function,\n\tprops: Object,\n\t__c: typeof Component,\n\t__: any,\n\t__k: any,\n};\n\ntype VNodes = VNode | Array<VNode>;\n\ntype Options = {\n\trender: (vnode: VNode) => void;\n};\n*/\n\nexport default function prepass(\n\tvnode /*: VNode */,\n\tvisitor /*: ?(vnode: VNode, component: typeof Component) => ?Promise<any> */,\n\tcontext /*: ?Object */,\n\tparent /*: ?VNode */,\n) /*: Promise<any|Array<any>> */ {\n\t// null, boolean, text, number \"vnodes\" need to prepassing...\n\tif (vnode == null || typeof vnode !== \"object\") {\n\t\treturn Promise.resolve();\n\t}\n\n\tlet nodeName = vnode.type,\n\t\tprops = vnode.props,\n\t\tchildren = [];\n\tcontext = context || {};\n\n\tvnode[_parent] = parent;\n\n\tif (\n\t\ttypeof nodeName === \"function\" &&\n\t\tnodeName !== Fragment &&\n\t\tnodeName !== Suspense // We're handling Suspense the same way as we do fragments as we do not want something to catch promises during prepass\n\t) {\n\t\tlet doRender /* : () => Promise<void> */;\n\t\tlet c = (vnode.__c = new Component(props, context));\n\t\t// initialize components in dirty state so setState() doesn't enqueue re-rendering:\n\t\tc.__d = true;\n\t\tc.__v = vnode;\n\t\t/* istanbul ignore else */\n\t\tif (c.state === undefined) {\n\t\t\tc.state = {};\n\t\t}\n\n\t\tlet isClassComponent = false;\n\n\t\t// Necessary for createContext api. Setting this property will pass\n\t\t// the context value as `this.context` just for this component.\n\t\tlet cxType = nodeName.contextType;\n\t\tlet provider = cxType && context[cxType.__c];\n\t\tlet cctx =\n\t\t\tcxType != null\n\t\t\t\t? provider\n\t\t\t\t\t? provider.props.value\n\t\t\t\t\t: cxType[createContextDefaultValue] ||\n\t\t\t\t\t  cxType[createContextDefaultValueNew]\n\t\t\t\t: context;\n\n\t\tvnode[_parent] = parent\n\n\t\tif (\n\t\t\t!nodeName.prototype ||\n\t\t\ttypeof nodeName.prototype.render !== \"function\"\n\t\t) {\n\t\t\t// stateless functional components\n\t\t\tdoRender = () => {\n\t\t\t\ttry {\n\t\t\t\t\tconst previousSkipEffects = options[_skipEffects];\n\t\t\t\t\toptions[_skipEffects] = true;\n\t\t\t\t\t// options.render was renamed to _render (mangled to __r)\n\t\t\t\t\tif (options.render) options.render(vnode);\n\t\t\t\t\tif (options.__r) {\n\t\t\t\t\t\toptions.__r(vnode);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst renderResult = Promise.resolve(\n\t\t\t\t\t\tnodeName.call(vnode.__c, props, cctx)\n\t\t\t\t\t);\n\t\t\t\t\toptions[_skipEffects] = previousSkipEffects;\n\t\t\t\t\treturn renderResult;\n\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (e && e.then) {\n\t\t\t\t\t\treturn e.then(doRender, doRender);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn Promise.reject(e);\n\t\t\t\t}\n\t\t\t};\n\t\t} else {\n\t\t\tisClassComponent = true;\n\n\t\t\t// class-based components\n\t\t\t// c = new nodeName(props, context);\n\t\t\tc = vnode.__c = new nodeName(props, cctx);\n\t\t\t// initialize components in dirty state so setState() doesn't enqueue re-rendering:\n\t\t\tc.__d = true;\n\t\t\tc.__v = vnode;\n\t\t\tc.props = props;\n\t\t\tc.context = cctx;\n\t\t\tif (c.state === undefined) {\n\t\t\t\tc.state = {};\n\t\t\t}\n\n\t\t\t// TODO: does react-ssr-prepass call the visitor before lifecycle hooks?\n\t\t\tif (nodeName.getDerivedStateFromProps)\n\t\t\t\tc.state = assign(\n\t\t\t\t\tassign({}, c.state),\n\t\t\t\t\tnodeName.getDerivedStateFromProps(c.props, c.state)\n\t\t\t\t);\n\t\t\telse if (c.componentWillMount) c.componentWillMount();\n\n\t\t\tdoRender = () => {\n\t\t\t\ttry {\n\t\t\t\t\t// options.render was renamed to _render (mangled to __r)\n\t\t\t\t\tif (options.render) options.render(vnode);\n\t\t\t\t\tif (options.__r) options.__r(vnode);\n\t\t\t\t\treturn Promise.resolve(c.render(c.props, c.state, c.context));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (e && e.then) {\n\t\t\t\t\t\treturn e.then(doRender, doRender);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn Promise.reject(e);\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\tif (options[_diff]) {\n\t\t\toptions[_diff](vnode)\n\t\t}\n\n\t\treturn (visitor\n\t\t\t? (\n\t\t\t\t\tvisitor(vnode, isClassComponent ? c : undefined) || Promise.resolve()\n\t\t\t  ).then(doRender)\n\t\t\t: doRender()\n\t\t).then((rendered) => {\n\t\t\tif (c.getChildContext) {\n\t\t\t\tcontext = assign(assign({}, context), c.getChildContext());\n\t\t\t}\n\n\t\t\tif (Array.isArray(rendered)) {\n\t\t\t\tvnode[_children] = [];\n\t\t\t\treturn Promise.all(\n\t\t\t\t\trendered.map((node) => {\n\t\t\t\t\t\tvnode[_children].push(node);\n\t\t\t\t\t\treturn prepass(node, visitor, context, vnode)\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn prepass(rendered, visitor, context, vnode);\n\t\t});\n\t} else {\n\t\tif (options[_diff]) options[_diff](vnode)\n\t}\n\n\tif (props && getChildren((children = []), props.children).length) {\n\t\tvnode[_children] = [];\n\t\treturn Promise.all(\n\t\t\tchildren.map((child) => {\n\t\t\t\tvnode[_children].push(child);\n\t\t\t\treturn prepass(child, visitor, context, vnode)\n\t\t\t})\n\t\t);\n\t}\n\n\treturn Promise.resolve();\n}\n"],"names":["assign","obj","props","i","getChildren","accumulator","children","Array","isArray","reduce","push","prepass","vnode","visitor","context","parent","Promise","resolve","nodeName","type","Fragment","Suspense","doRender","c","__c","Component","__d","__v","undefined","state","isClassComponent","cxType","contextType","provider","cctx","value","prototype","render","getDerivedStateFromProps","componentWillMount","options","__r","e","then","reject","previousSkipEffects","renderResult","call","rendered","getChildContext","all","map","node","length","child"],"mappings":"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"}